local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer

local MAX_DISTANCE = 300 -- Lower this to improve performance if needed
local ESPs = {}

-- Create a single ESP box
local function CreateBox()
	local box = Drawing.new("Square")
	box.Color = Color3.fromRGB(255, 0, 0)
	box.Thickness = 1
	box.Transparency = 1
	box.Filled = false
	box.Visible = false
	return box
end

-- Setup ESP for one player
local function SetupPlayer(player)
	if player == LocalPlayer or ESPs[player] then return end

	local box = CreateBox()
	local connections = {}

	local function OnCharacterAdded(character)
		task.wait(0.5)
		local humanoid = character:FindFirstChildOfClass("Humanoid")
		if humanoid then
			table.insert(connections, humanoid.Died:Connect(function()
				box.Visible = false
			end))
		end
	end

	if player.Character then
		OnCharacterAdded(player.Character)
	end

	table.insert(connections, player.CharacterAdded:Connect(OnCharacterAdded))
	table.insert(connections, player.AncestryChanged:Connect(function(_, parent)
		if not parent then
			box.Visible = false
		end
	end))

	ESPs[player] = { box = box, connections = connections }
end

-- Clean up ESP for player
local function CleanupPlayer(player)
	local data = ESPs[player]
	if not data then return end

	data.box.Visible = false
	data.box:Remove()

	for _, conn in ipairs(data.connections) do
		pcall(function() conn:Disconnect() end)
	end

	ESPs[player] = nil
end

-- Setup all current players
for _, player in ipairs(Players:GetPlayers()) do
	SetupPlayer(player)
end

-- Handle new and leaving players
Players.PlayerAdded:Connect(SetupPlayer)
Players.PlayerRemoving:Connect(CleanupPlayer)

-- Main ESP render loop
RunService.RenderStepped:Connect(function()
	local camPos = Camera.CFrame.Position

	for player, data in pairs(ESPs) do
		local char = player.Character
		local box = data.box

		if not char then
			box.Visible = false
			continue
		end

		local hrp = char:FindFirstChild("HumanoidRootPart")
		local head = char:FindFirstChild("Head")
		local humanoid = char:FindFirstChildOfClass("Humanoid")

		if not hrp or not head or not humanoid or humanoid.Health <= 0 then
			box.Visible = false
			continue
		end

		local distance = (camPos - hrp.Position).Magnitude
		if distance > MAX_DISTANCE then
			box.Visible = false
			continue
		end

		local top, onScreenTop = Camera:WorldToViewportPoint(head.Position + Vector3.new(0, 0.5, 0))
		local bottom, onScreenBottom = Camera:WorldToViewportPoint(hrp.Position - Vector3.new(0, 3, 0))

		if onScreenTop and onScreenBottom then
			local height = math.abs(bottom.Y - top.Y)
			local width = height / 2
			box.Size = Vector2.new(width, height)
			box.Position = Vector2.new(top.X - width / 2, top.Y)
			box.Visible = true
		else
			box.Visible = false
		end
	end
end)

-- Debug: Print number of Drawing objects every 5 seconds
task.spawn(function()
	while true do
		local total = 0
		for _, v in pairs(getgc(true)) do
			if typeof(v) == "table" and v.__type == "DrawingObject" then
				total += 1
			end
		end
		print("[DEBUG] Drawing objects in memory:", total)
		task.wait(5)
	end
end)
